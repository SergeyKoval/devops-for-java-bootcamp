#cloud-config
repo_update: true
repo_upgrade: all
packages:
  - apache2
  - php
runcmd:
  - [ chown, "ubuntu:ubuntu", "/home/ubuntu/.ssh/instance1_id_rsa" ]
  - systemctl start apache2
  - sudo systemctl enable apache2
  - chmod 2775 /var/www
  - sudo apt-get install ca-certificates curl
  - sudo install -m 0755 -d /etc/apt/keyrings
  - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - sudo chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  - sudo apt-get update
  - sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
write_files:
  - path: /home/ubuntu/.ssh/instance1_id_rsa
    encoding: b64
    permissions: '0600'
    content: ${jsonencode(instance1_id_rsa)}
  - path: /var/www/html/info.php
    encoding: b64
    permissions: '0664'
    content: PD9waHAKZnVuY3Rpb24gZ2V0T1NJbmZvcm1hdGlvbigpCiAgICB7CiAgICAgICAgaWYgKGZhbHNlID09IGZ1bmN0aW9uX2V4aXN0cygic2hlbGxfZXhlYyIpIHx8IGZhbHNlID09IGlzX3JlYWRhYmxlKCIvZXRjL29zLXJlbGVhc2UiKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgICRvcyAgICAgICAgID0gc2hlbGxfZXhlYygnY2F0IC9ldGMvb3MtcmVsZWFzZScpOwogICAgICAgICRsaXN0SWRzICAgID0gcHJlZ19tYXRjaF9hbGwoJy8uKj0vJywgJG9zLCAkbWF0Y2hMaXN0SWRzKTsKICAgICAgICAkbGlzdElkcyAgICA9ICRtYXRjaExpc3RJZHNbMF07CgogICAgICAgICRsaXN0VmFsICAgID0gcHJlZ19tYXRjaF9hbGwoJy89LiovJywgJG9zLCAkbWF0Y2hMaXN0VmFsKTsKICAgICAgICAkbGlzdFZhbCAgICA9ICRtYXRjaExpc3RWYWxbMF07CgogICAgICAgIGFycmF5X3dhbGsoJGxpc3RJZHMsIGZ1bmN0aW9uKCYkdiwgJGspewogICAgICAgICAgICAkdiA9IHN0cnRvbG93ZXIoc3RyX3JlcGxhY2UoJz0nLCAnJywgJHYpKTsKICAgICAgICB9KTsKCiAgICAgICAgYXJyYXlfd2FsaygkbGlzdFZhbCwgZnVuY3Rpb24oJiR2LCAkayl7CiAgICAgICAgICAgICR2ID0gcHJlZ19yZXBsYWNlKCcvPXwiLycsICcnLCAkdik7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBhcnJheV9jb21iaW5lKCRsaXN0SWRzLCAkbGlzdFZhbCk7CiAgICB9CgpmdW5jdGlvbiBnZXRTeXN0ZW1NZW1JbmZvKCkKewogICAgJGRhdGEgPSBleHBsb2RlKCJcbiIsIGZpbGVfZ2V0X2NvbnRlbnRzKCIvcHJvYy9tZW1pbmZvIikpOwogICAgJG1lbWluZm8gPSBhcnJheSgpOwogICAgZm9yZWFjaCAoJGRhdGEgYXMgJGxpbmUpIHsKICAgICAgICBsaXN0KCRrZXksICR2YWwpID0gZXhwbG9kZSgiOiIsICRsaW5lKTsKICAgICAgICAkbWVtaW5mb1ska2V5XSA9IHRyaW0oJHZhbCk7CiAgICB9CiAgICByZXR1cm4gJG1lbWluZm87Cn0KCiRtZW1faW5mbyA9IGdldFN5c3RlbU1lbUluZm8oKTsKJG9zX2luZm8gPSBnZXRPU0luZm9ybWF0aW9uKCk7CiRieXRlcyA9IGRpc2tfZnJlZV9zcGFjZSgiLyIpOwokc2lfcHJlZml4ID0gYXJyYXkoICdCJywgJ0tCJywgJ01CJywgJ0dCJywgJ1RCJywgJ0VCJywgJ1pCJywgJ1lCJyApOwokYmFzZSA9IDEwMjQ7CiRjbGFzcyA9IG1pbigoaW50KWxvZygkYnl0ZXMgLCAkYmFzZSkgLCBjb3VudCgkc2lfcHJlZml4KSAtIDEpOwoKcHJpbnRfcigiPGRpdj5IZWxsbyB3b3JsZCBmb3IgdGFzayAxPC9kaXY+Iik7CgpwcmludF9yKCI8ZGl2PkZyZWUgZGlzayBzcGFjZTogIi5zcHJpbnRmKCclMS4yZicgLCAkYnl0ZXMgLyBwb3coJGJhc2UsJGNsYXNzKSkgLiAnICcgLiAkc2lfcHJlZml4WyRjbGFzc10uIjwvZGl2PiIpOwpwcmludF9yKCI8ZGl2PlNlcnZlciBPUzogIi4kb3NfaW5mb1sncHJldHR5X25hbWUnXS4iPC9kaXY+Iik7CnByaW50X3IoIjxkaXY+VG90YWwgbWVtb3J5OiAiLiRtZW1faW5mb1snTWVtVG90YWwnXS4iPC9kaXY+Iik7CnByaW50X3IoIjxkaXY+RnJlZSBtZW1vcnk6ICIuJG1lbV9pbmZvWydNZW1GcmVlJ10uIjwvZGl2PjwvYnI+PC9icj48L2JyPiIpOwoKcHJpbnRfcigiPGRpdj5SdW5uaW5nIHByb2Nlc3Nlczo8L2Rpdj4iKTsKJGV4ZWNzdHJpbmc9J3BzIGZhdXgnOwokb3V0cHV0PSIiOwpleGVjKCRleGVjc3RyaW5nLCAkb3V0cHV0KTsKZm9yZWFjaCgkb3V0cHV0IGFzICRvdXRwdXRfaXRlbSkgewogIHByaW50X3IoIjxkaXY+Ii4kb3V0cHV0X2l0ZW0uIjwvZGl2PiIpOwp9Cj8+Cg==
sh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDWEk7K7rngzzusR1VkEvQ5K67s0LkxgSEYaV4x4vqk4/81UE8N3W64a/v124q61fhT647k68Mv+F2EVnd87z4ROK+oRsjmGDFIJAAGxuWVw4XdYFO/1xdX/Zt9vjS1xnJhPOwnCmbPeYRHjtS1mYdAiO6yDmHmpK3xvsG79AOx9f9jmk4U04vRHwQEkUshjqaFE6BEzBKcWlndnted+W+ADvNZTFVew12fgPBpgMOFAEYqfaybwaBz76+qp8lByFF1vi1HnXjZ8tWVzUFve2/iyRFe/kHERF6bL7cl3jjaipoxzyGo6uIK/kQ4TF2FxMze3sb/pIlN/dH6by/l2A+MUpYaeUotlMKlreZ1jhF2tU5b9+bAWXW8OBNkj+4zaEE3IatRVWciVIyju7mSCrDztxMWO+xxwr4JQn6kpyuZXuIiYkivzYwoN9p/dum04ijvc8AFrFcVrfscpYvaNeuPmBJ4MUGtErppDyFZVGnVWx8cerhXJCAgEWugr6yuenc= instance2_id_rsa
